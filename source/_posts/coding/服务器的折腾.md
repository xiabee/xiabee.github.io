---
title: 服务器的折腾
date: 2022-2-3 20:00:23
tags:
  - docker
  - linux
  - vps
categories:
  - coding
abbrlink: vps-toss
---

## 准备工作

* 一台`VPS`：腾讯云学生特惠，`2核4G内存 8M带宽`

* 一个域名：[xiabee.cn](https://xiabee.cn)

* 一点点[容器使用技巧](https://blog.xiabee.cn/posts/docker-commands/)

## 需求分析

服务器里面跑一些`WEB`应用，包括但不限于个人博客、个人网盘、共享编辑器、邮件系统等，~~如果有时间的话可以写几个小程序挂着玩~~。

如果还有时间的话可以考虑搭一个`Cobalt Strike`的服务器......

## 当前布局

* `WordPress`[个人博客](https://xiabee.cn)

* `CodiMD`[共享编辑器](https://xiabee.cn:3000)

* `NEXTCloud`[个人网盘](https://xiabee.cn:5000)

考虑到多个服务可以共用一个`SSL`证书，也方便后续的证书更换，我单独设置了一个`SSL`模块，用于把同一套证书映射到不同的服务中去。

三个服务共用一套`SSL`证书：

<img title="" src="https://tva1.sinaimg.cn/large/0084b03xgy1gz0m257numj30cc0jswir.jpg" alt="image.png" data-align="center" width="297">

## 个人博客

### 需求

* 因为习惯了`Wordpress`，所以目前的博客还是基于`Wordpress`搭建的，选用的主题是[Sakura](https://github.com/mashirozx/Sakura)。

### 搭建

* [Docker搭建Wordpress个人博客 · xiabee-瞎哔哔](https://blog.xiabee.cn/posts/wordpress-docker/)

* 将原来的`docker-compose`修改一下，映射目录写`ssl`证书在宿主机的绝对路径

### 迁移

博客内容是从原来的博客（阿里云）里面直接迁移过来的，利用`Wordpress`原生的迁移工具。

但是原来的`xiabee.cn`解析到阿里云服务器中，`xyj.xiabee.cn`解析到当前（腾讯云）服务器；现在将`xyj.xiabee.cn`弃置，直接把`xiabee.cn`解析到腾讯云服务器中。

#### Bugs

在换域名的时候遇到一些`bug`：

* `DNS`解析有缓存和延迟，没有设置`301`，导致博客主站地址查询不到

* 在博客出的过程中，使用的媒体文件均引用自`xyj.xiabee.cn`，导致最后图片显示失败

<img title="" src="https://tva1.sinaimg.cn/large/0084b03xgy1gz0mdttyn4j30u01shdia.jpg" alt="349a5b09d06ce60c562754f20a7238e.jpg" data-align="center" width="219">

#### Solves

* `DNS`解析需要时间，一般十分钟以内都能解决，慢慢等就行

* 把所有的`xyj.xiabee.cn`都改成`xiabee.cn`就好......当然手动改是不可能的，直接强改数据库就行：
  
  * 进入`mariadb`容器
  
  * 登录数据库
  
  * 执行命令：`UPDATE wp_posts SET post_content = replace(post_content,'xyj.xiabee.cn','xiabee.cn');`

### 最终效果

<img title="" src="https://tva1.sinaimg.cn/large/0084b03xgy1gz0mmm098ej31hc0sv7jr.jpg" alt="image.png" data-align="center">

## 个人网盘

### 需求

* 基本能跑满`8M`带宽

* 支持手机图片自动备份等

所以最后选择了`NextCloud`作为个人网盘进行施工。

### 搭建

* [Docker搭建NextCloud个人网盘 · xiabee-瞎哔哔](https://blog.xiabee.cn/posts/nextcloud-docker/)

### 迁移

#### Bugs

同样是换域名的问题，之前注册网盘的时候使用的是`xyj.xiabee.cn`，现在它认为使用的域名是不安全的域名，不支持登录。

#### Solves

修改`/nextcloud/app/config/config.php`（可能需要`sudo`权限），将`array`和`overwrite.cli.url`都改过来即可：

<img src="https://tva1.sinaimg.cn/large/0084b03xgy1gz0mrv7xtcj30ig0efgqn.jpg" title="" alt="image.png" data-align="center">

### 最终效果

<img src="https://tva1.sinaimg.cn/large/0084b03xgy1gz0mtyc0bnj31hc0p2gt6.jpg" title="" alt="image.png" data-align="center">

如何自动同步文件我们下次再讲（如果我还记得的话X

## Markdown共享编辑器

### 需求

* 能多人在线编辑`Markdown`

* 能存档

最终选择：`CodiMD`

### 搭建

* [Docker搭建Markdown共享编辑器 · xiabee-瞎哔哔](https://blog.xiabee.cn/posts/markdown-docker/)

* 因为这个没啥留念的，换新的服务器就再搭了一个新的，所以不存在迁移`BUG`......

### 最终效果

![image.png](https://tva1.sinaimg.cn/large/0084b03xgy1gz0mzihtjij31hc0p2gu8.jpg)

## 其他

### 邮件系统

* 在做了，在做了

### Cobalt Strike

* 在做了，在做了
