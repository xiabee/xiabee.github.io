---
title: 利用企业微信机器人推送消息
date: 2022-10-21 12:00:23
tags:
  - serverless
categories:
  - coding
abbrlink: wechat-bot
---

# 背景

最近在研究云服务，`Serverless` 这些，有些程序已经实现完全自动化运行了，但是返回的结果要反复查看云服务日志或者个人邮箱，非常麻烦。于是决定写一个能自动给手机发送消息的东西——毕竟能时刻在线的，害得是手机（x）



不同的软件有不同的接口，找到对应的接口文档即可。因为我用微信用的最多，这里就先介绍一下如何使用微信进行消息的自动接收。



PS：为什么是接收不是收发呢......因为腾讯在某天之后限制了自建应用的 `IP`，[必须使用白名单](https://developer.work.weixin.qq.com/document/path/90372)，`Serverless` 这种连主机都碰不到的玩意就别想固定 `IP` 了......所以暂时先利用不需要绑定 `IP` 的企业微信机器人，来实现我们传递云服务反馈的功能。



# 准备工作

* 需要准备一个实名认证过的微信
* 利用该微信注册一个[企业微信](https://work.weixin.qq.com/wework_admin/frame#/index)
* 下载企业微信客户端，需要在客户端内进行相关设置



# 创建群机器人

* 企业创建完成后，会自动创建一个全员群，这个时候只有你自己在里面。这也是你加其他人进来之前唯一的可以加机器人的地方（千万不要像我一样傻愣愣的把群删掉，然后加不了机器人......）



<img src="https://tva1.sinaimg.cn/large/0084b03xgy1h7pog2moj4j30z40y2k27.jpg" alt="image.png" style="zoom:67%;" />

* 创建机器人后，会得到一个`webhook` 地址，我们可以参考官方提供的文档，利用 `webhook`，让机器人自动在群里推送消息

<img src="https://tva1.sinaimg.cn/large/0084b03xgy1h7poiqnpq6j30xm0aen17.jpg" alt="image.png" style="zoom:67%;" />



* 官方文档如下：

<img src="https://tva1.sinaimg.cn/large/0084b03xgy1h7pojli7v4j312411oqes.jpg" alt="image.png" style="zoom:67%;" />





# 验证群机器人

```bash
curl 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=693axxx6-7aoc-4bc4-97a0-0ec2sifa5aaa' \
   -H 'Content-Type: application/json' \
   -d '
   {
        "msgtype": "text",
        "text": {
            "content": "hello world"
        }
   }'
# 将上面的 key 换成自己的 webhook 里面的 key
```

企业微信的结果如下：执行成功

![image.png](https://tva1.sinaimg.cn/large/0084b03xgy1h7polkyq5aj30a204k0sw.jpg)



如果要自定义消息内容，只需要在程序里写好，然后用上面的 `json` 格式发送 `POST` 包就行～



# 绑定个人微信

如果不常用企业微信，可以把企业微信的消息同步到个人微信中，具体操作如下：

在**网页端**进入企业微信管理后台 ➡️ 我的企业 ➡️ 微信插件 ➡️ 邀请关注

![image.png](https://tva1.sinaimg.cn/large/0084b03xgy1h7pop3ogfoj30vi0u67ba.jpg)



绑定后，个人微信就可以收到企业微信的消息啦——企业微信，卸载！（划掉）

![image.png](https://tva1.sinaimg.cn/large/0084b03xgy1h7porg6irvj30u009jaal.jpg)



# 其他

如果想尝试自建应用来推送消息的可以参考官方文档：（比较折腾，尤其是 `IP` 白名单的问题，我放弃这个了）

> https://developer.work.weixin.qq.com/document/path/90372
>
> https://developer.work.weixin.qq.com/document/path/91039
